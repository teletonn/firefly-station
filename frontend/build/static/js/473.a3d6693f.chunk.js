"use strict";(self.webpackChunkmeshtastic_admin_frontend=self.webpackChunkmeshtastic_admin_frontend||[]).push([[473],{9266:(e,t,s)=>{s.r(t),s.d(t,{default:()=>M});var n=s(2555),a=s(5043),i=s(4117),o=s(6139),l=s(4603),r=s(9419),c=s(6036),d=s(2030),m=s(3318),u=s(2023),h=s(228),x=s.n(h),p=s(5088),g=s(8006),f=s(1360),j=s(4805),w=s(8693),_=s(3165),y=s(9855),b=s(7118),z=s(614),v=s(4596),N=s(7821),A=s(5592),k=s(3230),C=(s(6433),s(579));delete x().Icon.Default.prototype._getIconUrl,x().Icon.Default.mergeOptions({iconRetinaUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-2x.png",iconUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png"});const E=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"#3b82f6",t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return new h.DivIcon({html:'\n      <div style="\n        width: 12px;\n        height: 12px;\n        background-color: '.concat(e,";\n        border: 2px solid white;\n        border-radius: 50%;\n        box-shadow: 0 2px 4px rgba(0,0,0,0.3);\n        ").concat(t?"animation: pulse 1.5s infinite;":"",'\n      "></div>\n      <style>\n        @keyframes pulse {\n          0% { opacity: 1; }\n          50% { opacity: 0.5; }\n          100% { opacity: 1; }\n        }\n      </style>\n    '),className:"custom-marker",iconSize:[12,12],iconAnchor:[6,6]})},S={safe_zone:{color:"#10b981",fillColor:"#10b981",fillOpacity:.2,weight:2},danger_zone:{color:"#ef4444",fillColor:"#ef4444",fillOpacity:.3,weight:3},poi:{color:"#f59e0b",fillColor:"#f59e0b",fillOpacity:.25,weight:2},restricted:{color:"#8b5cf6",fillColor:"#8b5cf6",fillOpacity:.2,weight:2}},D=e=>{let{onDrawMode:t,onEditMode:s,onDeleteMode:n,isDrawing:a,isEditing:o,showHeatmap:l,onToggleHeatmap:r,showDwellTimes:c,onToggleDwellTimes:d}=e;const{t:m}=(0,i.Bd)();return(0,C.jsx)(N.A,{className:"absolute top-4 right-4 z-[1000] p-2",hover:!1,children:(0,C.jsxs)("div",{className:"flex flex-col space-y-2",children:[(0,C.jsx)(A.A,{variant:a?"primary":"ghost",size:"sm",onClick:t,icon:(0,C.jsx)(f.A,{className:"w-4 h-4"}),children:m("map.draw_zone")}),(0,C.jsx)(A.A,{variant:o?"primary":"ghost",size:"sm",onClick:s,icon:(0,C.jsx)(v.A,{className:"w-4 h-4"}),children:m("map.edit_zone")}),(0,C.jsx)(A.A,{variant:"ghost",size:"sm",onClick:n,icon:(0,C.jsx)(y.A,{className:"w-4 h-4"}),children:m("map.delete_zone")}),(0,C.jsx)("div",{className:"border-t border-gray-600 my-2"}),(0,C.jsx)(A.A,{variant:l?"primary":"ghost",size:"sm",onClick:r,icon:(0,C.jsx)(g.A,{className:"w-4 h-4"}),children:m("map.heatmap")}),(0,C.jsx)(A.A,{variant:c?"primary":"ghost",size:"sm",onClick:d,icon:(0,C.jsx)(p.A,{className:"w-4 h-4"}),children:m("map.dwell_times")})]})})},T=e=>{let{zone:t,onClose:s,onEdit:o,onDelete:l,isEditing:r,onSave:c,onCancel:d}=e;const{t:m}=(0,i.Bd)(),[u,h]=(0,a.useState)({name:"",description:"",center_latitude:0,center_longitude:0,radius_meters:100,zone_type:"safe_zone"});(0,a.useEffect)(()=>{t&&h({name:t.name||"",description:t.description||"",center_latitude:t.center_latitude||0,center_longitude:t.center_longitude||0,radius_meters:t.radius_meters||100,zone_type:t.zone_type||"safe_zone"})},[t]);const x=()=>{c&&c(t.id,u)},p=()=>{d&&d()};return t?r?(0,C.jsx)(N.A,{className:"absolute top-4 left-4 z-[1000] w-80",children:(0,C.jsx)(k.A,{title:m("zones.edit"),subtitle:t.name,actions:(0,C.jsxs)("div",{className:"flex space-x-2",children:[(0,C.jsx)(A.A,{size:"sm",variant:"primary",onClick:x,children:(0,C.jsx)(w.A,{className:"w-4 h-4"})}),(0,C.jsx)(A.A,{size:"sm",variant:"ghost",onClick:p,children:(0,C.jsx)(z.A,{className:"w-4 h-4"})})]}),children:(0,C.jsxs)("div",{className:"space-y-3",children:[(0,C.jsxs)("div",{children:[(0,C.jsx)("label",{className:"block text-sm font-medium text-gray-300 mb-1",children:m("zones.name")}),(0,C.jsx)("input",{type:"text",value:u.name,onChange:e=>h(t=>(0,n.A)((0,n.A)({},t),{},{name:e.target.value})),className:"w-full px-2 py-1 bg-white/10 border border-white/20 rounded text-white text-sm focus:outline-none focus:ring-1 focus:ring-blue-500"})]}),(0,C.jsxs)("div",{children:[(0,C.jsx)("label",{className:"block text-sm font-medium text-gray-300 mb-1",children:m("zones.description")}),(0,C.jsx)("textarea",{value:u.description,onChange:e=>h(t=>(0,n.A)((0,n.A)({},t),{},{description:e.target.value})),rows:2,className:"w-full px-2 py-1 bg-white/10 border border-white/20 rounded text-white text-sm focus:outline-none focus:ring-1 focus:ring-blue-500"})]}),(0,C.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,C.jsxs)("div",{children:[(0,C.jsx)("label",{className:"block text-sm font-medium text-gray-300 mb-1",children:m("zones.latitude")}),(0,C.jsx)("input",{type:"number",step:"any",value:u.center_latitude,onChange:e=>h(t=>(0,n.A)((0,n.A)({},t),{},{center_latitude:parseFloat(e.target.value)})),className:"w-full px-2 py-1 bg-white/10 border border-white/20 rounded text-white text-sm focus:outline-none focus:ring-1 focus:ring-blue-500"})]}),(0,C.jsxs)("div",{children:[(0,C.jsx)("label",{className:"block text-sm font-medium text-gray-300 mb-1",children:m("zones.longitude")}),(0,C.jsx)("input",{type:"number",step:"any",value:u.center_longitude,onChange:e=>h(t=>(0,n.A)((0,n.A)({},t),{},{center_longitude:parseFloat(e.target.value)})),className:"w-full px-2 py-1 bg-white/10 border border-white/20 rounded text-white text-sm focus:outline-none focus:ring-1 focus:ring-blue-500"})]})]}),(0,C.jsxs)("div",{children:[(0,C.jsxs)("label",{className:"block text-sm font-medium text-gray-300 mb-1",children:[m("zones.radius")," (m)"]}),(0,C.jsx)("input",{type:"number",min:"1",value:u.radius_meters,onChange:e=>h(t=>(0,n.A)((0,n.A)({},t),{},{radius_meters:parseInt(e.target.value)})),className:"w-full px-2 py-1 bg-white/10 border border-white/20 rounded text-white text-sm focus:outline-none focus:ring-1 focus:ring-blue-500"})]})]})})}):(0,C.jsx)(N.A,{className:"absolute top-4 left-4 z-[1000] w-80",children:(0,C.jsx)(k.A,{title:t.name,subtitle:"".concat(m("zones.type"),": ").concat(m("zones.".concat(t.zone_type))),actions:(0,C.jsxs)("div",{className:"flex space-x-2",children:[(0,C.jsx)(A.A,{size:"sm",variant:"ghost",onClick:o,children:(0,C.jsx)(v.A,{className:"w-4 h-4"})}),(0,C.jsx)(A.A,{size:"sm",variant:"ghost",onClick:l,children:(0,C.jsx)(y.A,{className:"w-4 h-4"})}),(0,C.jsx)(A.A,{size:"sm",variant:"ghost",onClick:s,children:(0,C.jsx)(j.A,{className:"w-4 h-4"})})]}),children:(0,C.jsxs)("div",{className:"space-y-3",children:[(0,C.jsx)("p",{className:"text-sm text-gray-300",children:t.description}),(0,C.jsxs)("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[(0,C.jsxs)("div",{children:[(0,C.jsxs)("span",{className:"text-gray-400",children:[m("zones.center"),":"]}),(0,C.jsxs)("div",{className:"text-white",children:[t.center_latitude.toFixed(6),", ",t.center_longitude.toFixed(6)]})]}),(0,C.jsxs)("div",{children:[(0,C.jsxs)("span",{className:"text-gray-400",children:[m("zones.radius"),":"]}),(0,C.jsxs)("div",{className:"text-white",children:[t.radius_meters,"m"]})]})]}),(0,C.jsxs)("div",{className:"text-xs text-gray-400",children:[m("common.create"),": ",new Date(t.created_at).toLocaleDateString()]})]})})}):null},O=e=>{var t;let{user:s,onClick:n}=e;const{t:a}=(0,i.Bd)(),o=[s.latitude,s.longitude],l=s.is_moving||!1,r=new Date(s.last_location_update),d=Math.floor((Date.now()-r)/6e4);return(0,C.jsx)(c.p,{position:o,icon:E(s.current_zone_id?(null===(t=S[s.zone_type])||void 0===t?void 0:t.color)||"#3b82f6":"#6b7280",l),eventHandlers:{click:()=>n&&n(s)},children:(0,C.jsx)(m.z,{children:(0,C.jsxs)("div",{className:"p-2",children:[(0,C.jsx)("h3",{className:"font-semibold text-gray-900",children:s.long_name||s.short_name}),(0,C.jsxs)("p",{className:"text-sm text-gray-600",children:[a("users.last_seen"),": ",d," ",a("time.minutes_ago")]}),(0,C.jsxs)("p",{className:"text-sm text-gray-600",children:[a("users.status"),": ","online"===s.device_status?a("users.online"):a("users.offline")]}),s.battery_level&&(0,C.jsxs)("p",{className:"text-sm text-gray-600",children:[a("users.battery"),": ",s.battery_level,"%"]}),s.current_zone_id&&(0,C.jsxs)("p",{className:"text-sm text-blue-600",children:["Zone: ",s.current_zone_name]})]})})})},I=e=>{let{trail:t,color:s="#3b82f6"}=e;if(!t||t.length<2)return null;const n=t.map(e=>[e.latitude,e.longitude]);return(0,C.jsx)(d.R,{positions:n,pathOptions:{color:s,weight:2,opacity:.6,dashArray:"5, 5"}})},B=e=>{let{dwellTimes:t}=e;return t&&0!==t.length?(0,C.jsx)(C.Fragment,{children:t.map((e,t)=>(0,C.jsx)(l.j,{center:[e.center_lat||0,e.center_lon||0],radius:50,pathOptions:{color:"#ff6b6b",fillColor:"#ff6b6b",fillOpacity:.8,weight:2},children:(0,C.jsx)(m.z,{children:(0,C.jsxs)("div",{className:"p-2",children:[(0,C.jsx)("h3",{className:"font-semibold text-gray-900",children:e.zone_name}),(0,C.jsxs)("p",{className:"text-sm text-gray-600",children:["Users: ",e.users,(0,C.jsx)("br",{}),"Avg Dwell: ",e.avg_dwell_hours.toFixed(1)," hours"]})]})})},"dwell-".concat(t)))}):null},M=e=>{let{className:t="",center:s=[55.7558,37.6176],zoom:c=13,users:d=[],zones:h=[],trails:x=[],onUserClick:p}=e;const{t:g}=(0,i.Bd)(),{subscribe:f,isConnected:j}=(0,o.h3)(),w=(0,a.useRef)(),[y,z]=(0,a.useState)(null),[v,A]=(0,a.useState)(!1),[k,E]=(0,a.useState)(!1),[M,U]=(0,a.useState)([]),[F,H]=(0,a.useState)([]),[R,Z]=(0,a.useState)([]),[L,P]=(0,a.useState)(!1),[J,K]=(0,a.useState)([]),[W,q]=(0,a.useState)(!1),[G,Q]=(0,a.useState)(!1),[V,X]=(0,a.useState)(!1),[Y,$]=(0,a.useState)(!0);(0,a.useEffect)(()=>{ee(),te()},[]);const ee=async()=>{try{const e=localStorage.getItem("token"),t=await fetch("/api/zones/?limit=100&offset=0",{headers:{Authorization:e?"Bearer ".concat(e):""}});if(t.ok){const e=await t.json();H(e||[])}}catch(e){console.error("Error fetching zones:",e)}},te=async()=>{try{const e=localStorage.getItem("token"),t=await fetch("/api/users/?limit=100&offset=0",{headers:{Authorization:e?"Bearer ".concat(e):""}});if(t.ok){const e=await t.json();U(e.users||[])}}catch(e){console.error("Error fetching users:",e)}finally{$(!1)}},se=async e=>{try{const t=localStorage.getItem("token"),s=await fetch("/api/zones/",{method:"POST",headers:{"Content-Type":"application/json",Authorization:t?"Bearer ".concat(t):""},body:JSON.stringify(e)});if(s.ok){const e=await s.json();return H(t=>[...t,e]),e}console.error("Error creating zone:",s.statusText)}catch(t){console.error("Error creating zone:",t)}return null};(0,a.useEffect)(()=>{U(d),H(h),Z(x)},[d,h,x]);(0,a.useEffect)(()=>{W&&(async()=>{try{const e=await fetch("/api/geolocation/analytics/dwell-time?days=7"),t=await e.json();K(t.dwell_times||[])}catch(e){console.error("Error fetching dwell times:",e)}})()},[W]),(0,a.useEffect)(()=>{const e=f("location_update",e=>{const t=e.data;U(e=>e.map(e=>e.id===t.user_id?(0,n.A)((0,n.A)({},e),{},{latitude:t.latitude,longitude:t.longitude,altitude:t.altitude,last_location_update:t.timestamp,is_moving:!0}):e)),Z(e=>{const s=e.find(e=>e.user_id===t.user_id);return s?(s.points.push({latitude:t.latitude,longitude:t.longitude,timestamp:t.timestamp}),s.points.length>50&&(s.points=s.points.slice(-50))):e.push({user_id:t.user_id,color:"#3b82f6",points:[{latitude:t.latitude,longitude:t.longitude,timestamp:t.timestamp}]}),[...e]})}),t=f("zone_change",e=>{const t=e.data;U(e=>e.map(e=>e.id===t.user_id?(0,n.A)((0,n.A)({},e),{},{current_zone_id:t.new_zone_id,current_zone_name:t.new_zone_name}):e))}),s=f("zone_update",e=>{const t=e.data;"create"===t.action?H(e=>[...e,t.zone]):"update"===t.action?H(e=>e.map(e=>e.id===t.zone.id?t.zone:e)):"delete"===t.action&&H(e=>e.filter(e=>e.id!==t.zone_id))});return()=>{e(),t(),s()}},[f]);const ne=async e=>{window.confirm('Delete zone "'.concat(e.name,'"?'))&&await(async e=>{try{const t=localStorage.getItem("token"),s=await fetch("/api/zones/".concat(e),{method:"DELETE",headers:{Authorization:t?"Bearer ".concat(t):""}});if(s.ok)return H(t=>t.filter(t=>t.id!==e)),!0;console.error("Error deleting zone:",s.statusText)}catch(t){console.error("Error deleting zone:",t)}return!1})(e.id),z(null)};return(0,C.jsxs)("div",{className:"relative w-full h-full ".concat(t),children:[(0,C.jsxs)(r.W,{center:s,zoom:c,className:"w-full h-full z-0",ref:e=>{w.current=e},onClick:async e=>{if(e.originalEvent.ctrlKey){const t={name:"Zone ".concat(F.length+1),center_latitude:e.latlng.lat,center_longitude:e.latlng.lng,radius_meters:100,zone_type:"safe_zone"};console.log("Creating new zone via CTRL+click:",t),await se(t)}else if(v){const t={name:"Zone ".concat(F.length+1),center_latitude:e.latlng.lat,center_longitude:e.latlng.lng,radius_meters:100,zone_type:"safe_zone"};console.log("Creating new zone:",t),await se(t),A(!1)}},children:[(0,C.jsx)(u.e,{url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",attribution:'\xa9 <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}),F.map(e=>(0,C.jsx)(l.j,{center:[e.center_latitude,e.center_longitude],radius:e.radius_meters,pathOptions:S[e.zone_type]||S.safe_zone,eventHandlers:{click:t=>{t.originalEvent.stopPropagation(),t.originalEvent.ctrlKey?(z(e),X(!0),A(!1),E(!1),Q(!1)):G?ne(e):(e=>{z(e)})(e)}},children:(0,C.jsx)(m.z,{children:(0,C.jsxs)("div",{className:"p-2",children:[(0,C.jsx)("h3",{className:"font-semibold",children:e.name}),(0,C.jsx)("p",{className:"text-sm text-gray-600",children:e.description}),(0,C.jsxs)("p",{className:"text-xs text-gray-500",children:[g("zones.".concat(e.zone_type))," \u2022 ",e.radius_meters,"m radius"]})]})})},e.id)),M.map(e=>(0,C.jsx)(O,{user:e,onClick:p},e.id)),R.map((e,t)=>(0,C.jsx)(I,{trail:e.points,color:e.color||"#3b82f6"},t)),W&&(0,C.jsx)(B,{dwellTimes:J})]}),(0,C.jsx)(D,{onDrawMode:()=>{A(!v),E(!1),z(null)},onEditMode:()=>{E(!k),A(!1),z(null)},onDeleteMode:()=>{Q(!G),A(!1),E(!1)},isDrawing:v,isEditing:k,showHeatmap:L,onToggleHeatmap:()=>P(!L),showDwellTimes:W,onToggleDwellTimes:()=>q(!W)}),(0,C.jsx)(T,{zone:y,onClose:()=>{z(null),X(!1)},onEdit:async e=>{alert("Edit zone ".concat(e.name," - Feature not implemented in map view. Use Zones page.")),z(null)},onDelete:ne,isEditing:V,onSave:async(e,t)=>{await(async(e,t)=>{try{const s=localStorage.getItem("token"),n=await fetch("/api/zones/".concat(e),{method:"PUT",headers:{"Content-Type":"application/json",Authorization:s?"Bearer ".concat(s):""},body:JSON.stringify(t)});if(n.ok){const t=await n.json();return H(s=>s.map(s=>s.id===e?t:s)),t}console.error("Error updating zone:",n.statusText)}catch(s){console.error("Error updating zone:",s)}return null})(e,t),X(!1),z(null)},onCancel:()=>{X(!1),z(null)}}),Y&&(0,C.jsx)("div",{className:"absolute inset-0 bg-black/50 flex items-center justify-center z-[2000]",children:(0,C.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-accent-cyan"})}),(0,C.jsx)(N.A,{className:"absolute bottom-4 left-4 z-[1000] p-3",children:(0,C.jsxs)("div",{className:"flex items-center space-x-4 text-sm text-gray-300",children:[(0,C.jsxs)("div",{className:"flex items-center space-x-1",children:[(0,C.jsx)(_.A,{className:"w-4 h-4"}),(0,C.jsxs)("span",{children:[F.length," ",g("nav.zones")]})]}),(0,C.jsxs)("div",{className:"flex items-center space-x-1",children:[(0,C.jsx)(b.A,{className:"w-4 h-4"}),(0,C.jsxs)("span",{children:[M.length," ",g("nav.users")]})]}),(0,C.jsxs)("div",{className:"flex items-center space-x-1",children:[(0,C.jsx)("div",{className:"w-2 h-2 rounded-full ".concat(j?"bg-green-400":"bg-red-400")}),(0,C.jsx)("span",{children:g(j?"map.live":"map.offline")})]}),v&&(0,C.jsx)("div",{className:"text-blue-400",children:g("map.draw_zone_cancel")})]})})]})}}}]);
//# sourceMappingURL=473.a3d6693f.chunk.js.map